generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum ComicStatus {
  draft
  published
  completed
  hidden
}

enum ChapterStatus {
  draft
  published
}

enum CommentStatus {
  visible
  hidden
}

enum UserStatus {
  active
  pending
  inactive
}

enum Gender {
  male
  female
  other
}
model Comic {
  id               BigInt        @id @default(autoincrement()) @db.UnsignedBigInt
  slug             String        @unique @db.VarChar(255)
  title            String        @db.VarChar(255)
  description      String?       @db.Text
  cover_image      String?       @db.VarChar(500)
  author           String?       @db.VarChar(255)
  status           ComicStatus   @default(draft)
  created_user_id  BigInt?       @db.UnsignedBigInt
  updated_user_id  BigInt?       @db.UnsignedBigInt
  created_at       DateTime      @default(now()) @db.DateTime(0)
  updated_at       DateTime      @updatedAt @db.DateTime(0)
  deleted_at       DateTime?     @db.DateTime(0)

  stats            ComicStats?
  chapters         Chapter[]
  categoryLinks    ComicCategoryOnComic[]
  comments         Comment[]
  reviews          ComicReview[]
  views            ComicView[]

  @@map("comics")
  @@index([slug], map: "idx_slug")
  @@index([status], map: "idx_status")
  @@index([author], map: "idx_author")
  @@index([created_at], map: "idx_created_at")
  @@index([created_user_id], map: "idx_created_user_id")
  @@index([updated_user_id], map: "idx_updated_user_id")
  @@index([deleted_at], map: "idx_deleted_at")
}

model ComicStats {
  comic_id     BigInt   @id @db.UnsignedBigInt
  view_count   BigInt   @default(0) @db.UnsignedBigInt
  follow_count BigInt   @default(0) @db.UnsignedBigInt
  rating_count BigInt   @default(0) @db.UnsignedBigInt
  rating_sum   BigInt   @default(0) @db.UnsignedBigInt
  updated_at   DateTime @default(now()) @updatedAt @db.DateTime(0)

  comic        Comic    @relation(fields: [comic_id], references: [id], onDelete: Cascade)

  @@map("comic_stats")
  @@index([view_count], map: "idx_view_count")
  @@index([follow_count], map: "idx_follow_count")
  @@index([updated_at], map: "idx_updated_at")
}

model Chapter {
  id              BigInt        @id @default(autoincrement()) @db.UnsignedBigInt
  comic_id        BigInt        @db.UnsignedBigInt
  team_id         BigInt?       @db.UnsignedBigInt
  title           String        @db.VarChar(255)
  chapter_index   Int
  chapter_label   String?       @db.VarChar(50)
  status          ChapterStatus @default(draft)
  view_count      BigInt        @default(0) @db.UnsignedBigInt
  created_user_id BigInt?       @db.UnsignedBigInt
  updated_user_id BigInt?       @db.UnsignedBigInt
  created_at      DateTime      @default(now()) @db.DateTime(0)
  updated_at      DateTime      @updatedAt @db.DateTime(0)
  deleted_at      DateTime?     @db.DateTime(0)

  comic           Comic         @relation(fields: [comic_id], references: [id], onDelete: Cascade)
  pages           ChapterPage[]
  views           ComicView[]
  comments        Comment[]

  @@map("chapters")
  @@index([comic_id], map: "idx_comic_id")
  @@unique([comic_id, chapter_index], map: "idx_comic_chapter_unique")
  @@index([comic_id, chapter_index], map: "idx_comic_chapter_index")
  @@index([team_id], map: "idx_team_id")
  @@index([status], map: "idx_status")
  @@index([view_count], map: "idx_view_count")
  @@index([created_at], map: "idx_created_at")
  @@index([created_user_id], map: "idx_created_user_id")
  @@index([updated_user_id], map: "idx_updated_user_id")
  @@index([deleted_at], map: "idx_deleted_at")
}

model ComicCategory {
  id              BigInt                 @id @default(autoincrement()) @db.UnsignedBigInt
  name            String                 @db.VarChar(255)
  slug            String                 @unique @db.VarChar(255)
  description     String?                @db.Text
  created_user_id BigInt?                @db.UnsignedBigInt
  updated_user_id BigInt?                @db.UnsignedBigInt
  created_at      DateTime               @default(now()) @db.DateTime(0)
  updated_at      DateTime               @updatedAt @db.DateTime(0)
  deleted_at      DateTime?              @db.DateTime(0)

  comics          ComicCategoryOnComic[]

  @@map("comic_categories")
  @@index([slug], map: "idx_slug")
  @@index([name], map: "idx_name")
  @@index([created_at], map: "idx_created_at")
  @@index([created_user_id], map: "idx_created_user_id")
  @@index([updated_user_id], map: "idx_updated_user_id")
  @@index([deleted_at], map: "idx_deleted_at")
}

model ComicCategoryOnComic {
  comic_id          BigInt          @db.UnsignedBigInt
  comic_category_id BigInt          @db.UnsignedBigInt
  comic             Comic           @relation(fields: [comic_id], references: [id], onDelete: Cascade)
  category          ComicCategory   @relation(fields: [comic_category_id], references: [id], onDelete: Cascade)

  @@id([comic_id, comic_category_id])
  @@map("comic_category")
}

model GeneralConfig {
  id                 BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  site_name          String    @db.VarChar(255)
  site_description   String?   @db.Text
  site_logo          String?   @db.VarChar(500)
  site_favicon       String?   @db.VarChar(500)
  site_email         String?   @db.VarChar(255)
  site_phone         String?   @db.VarChar(20)
  site_address       String?   @db.Text
  site_copyright     String?   @db.VarChar(255)
  timezone           String    @db.VarChar(50)  @default("Asia/Ho_Chi_Minh")
  locale             String    @db.VarChar(10)  @default("vi")
  currency           String    @db.VarChar(10)  @default("VND")
  contact_channels   Json?
  meta_title         String?   @db.VarChar(255)
  meta_keywords      String?   @db.Text
  og_title           String?   @db.VarChar(255)
  og_description     String?   @db.Text
  og_image           String?   @db.VarChar(500)
  canonical_url      String?   @db.VarChar(500)
  google_analytics_id String?  @db.VarChar(50)
  google_search_console String? @db.VarChar(255)
  facebook_pixel_id  String?   @db.VarChar(50)
  twitter_site       String?   @db.VarChar(50)
  created_user_id    BigInt?   @db.UnsignedBigInt
  updated_user_id    BigInt?   @db.UnsignedBigInt
  created_at         DateTime  @default(now()) @db.DateTime(0)
  updated_at         DateTime  @updatedAt @db.DateTime(0)
  deleted_at         DateTime? @db.DateTime(0)

  @@map("general_configs")
  @@index([deleted_at], map: "idx_general_configs_deleted_at")
}

model EmailConfig {
  id             BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  smtp_host      String   @db.VarChar(255)
  smtp_port      Int      @default(587)
  smtp_secure    Boolean  @default(true)
  smtp_username  String   @db.VarChar(255)
  smtp_password  String   @db.VarChar(500)
  from_email     String   @db.VarChar(255)
  from_name      String   @db.VarChar(255)
  reply_to_email String?  @db.VarChar(255)
  created_user_id BigInt? @db.UnsignedBigInt
  updated_user_id BigInt? @db.UnsignedBigInt
  created_at      DateTime @default(now()) @db.DateTime(0)
  updated_at      DateTime @updatedAt @db.DateTime(0)
  deleted_at      DateTime? @db.DateTime(0)

  @@map("email_configs")
  @@index([deleted_at], map: "idx_email_configs_deleted_at")
}

model Comment {
  id              BigInt         @id @default(autoincrement()) @db.UnsignedBigInt
  user_id         BigInt         @db.UnsignedBigInt
  comic_id        BigInt         @db.UnsignedBigInt
  chapter_id      BigInt?        @db.UnsignedBigInt
  parent_id       BigInt?        @db.UnsignedBigInt
  content         String         @db.Text
  status          CommentStatus  @default(visible)
  created_user_id BigInt?        @db.UnsignedBigInt
  updated_user_id BigInt?        @db.UnsignedBigInt
  created_at      DateTime       @default(now()) @db.DateTime(0)
  updated_at      DateTime       @updatedAt @db.DateTime(0)
  deleted_at      DateTime?      @db.DateTime(0)

  comic           Comic          @relation(fields: [comic_id], references: [id], onDelete: Cascade)
  chapter         Chapter?       @relation(fields: [chapter_id], references: [id], onDelete: SetNull)
  user            User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  parent          Comment?       @relation("CommentToReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies         Comment[]      @relation("CommentToReplies")

  @@map("comments")
  @@index([user_id], map: "idx_user_id")
  @@index([comic_id], map: "idx_comic_id")
  @@index([chapter_id], map: "idx_chapter_id")
  @@index([parent_id], map: "idx_parent_id")
  @@index([status], map: "idx_status")
  @@index([created_at], map: "idx_created_at")
  @@index([comic_id, created_at], map: "idx_comic_created")
  @@index([chapter_id, created_at], map: "idx_chapter_created")
  @@index([created_user_id], map: "idx_created_user_id")
  @@index([updated_user_id], map: "idx_updated_user_id")
  @@index([deleted_at], map: "idx_deleted_at")
}

model ComicReview {
  id              BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  user_id         BigInt    @db.UnsignedBigInt
  comic_id        BigInt    @db.UnsignedBigInt
  rating          Int       @db.UnsignedTinyInt
  content         String?   @db.Text
  created_user_id BigInt?   @db.UnsignedBigInt
  updated_user_id BigInt?   @db.UnsignedBigInt
  created_at      DateTime  @default(now()) @db.DateTime(0)
  updated_at      DateTime  @updatedAt @db.DateTime(0)
  deleted_at      DateTime? @db.DateTime(0)

  comic           Comic     @relation(fields: [comic_id], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("comic_reviews")
  @@index([user_id], map: "idx_user_id")
  @@index([comic_id], map: "idx_comic_id")
  @@unique([user_id, comic_id], map: "idx_user_comic")
  @@index([rating], map: "idx_rating")
  @@index([created_at], map: "idx_created_at")
  @@index([created_user_id], map: "idx_created_user_id")
  @@index([updated_user_id], map: "idx_updated_user_id")
  @@index([deleted_at], map: "idx_deleted_at")
}

model ChapterPage {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  chapter_id  BigInt   @db.UnsignedBigInt
  page_number Int
  image_url   String   @db.VarChar(500)
  width       Int?
  height      Int?
  file_size   BigInt?  @db.UnsignedBigInt
  created_at  DateTime @default(now()) @db.DateTime(0)

  chapter     Chapter  @relation(fields: [chapter_id], references: [id], onDelete: Cascade)

  @@map("chapter_pages")
  @@index([chapter_id], map: "idx_chapter_id")
  @@index([chapter_id, page_number], map: "idx_chapter_page")
  @@unique([chapter_id, page_number], map: "idx_chapter_page_unique")
}

model ComicView {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  comic_id    BigInt    @db.UnsignedBigInt
  chapter_id  BigInt?   @db.UnsignedBigInt
  user_id     BigInt?   @db.UnsignedBigInt
  ip          String?   @db.VarChar(45)
  user_agent  String?   @db.VarChar(500)
  created_at  DateTime  @default(now()) @db.DateTime(0)

  comic       Comic     @relation(fields: [comic_id], references: [id], onDelete: Cascade)
  chapter     Chapter?  @relation(fields: [chapter_id], references: [id], onDelete: SetNull)
  user        User?     @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@map("comic_views")
  @@index([comic_id], map: "idx_comic_id")
  @@index([chapter_id], map: "idx_chapter_id")
  @@index([user_id], map: "idx_user_id")
  @@index([created_at], map: "idx_created_at")
  @@index([comic_id, created_at], map: "idx_comic_created")
  @@index([chapter_id, created_at], map: "idx_chapter_created")
}

model User {
  id               BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  username         String?    @unique @db.VarChar(50)
  email            String?    @unique @db.VarChar(255)
  phone            String?    @unique @db.VarChar(20)
  password         String?    @db.VarChar(255)
  status           UserStatus @default(active)
  email_verified_at DateTime? @db.DateTime(0)
  phone_verified_at DateTime? @db.DateTime(0)
  last_login_at    DateTime?  @db.DateTime(0)
  remember_token   String?    @db.VarChar(100)
  created_user_id  BigInt?    @db.UnsignedBigInt
  updated_user_id  BigInt?    @db.UnsignedBigInt
  created_at       DateTime   @default(now()) @db.DateTime(0)
  updated_at       DateTime   @updatedAt @db.DateTime(0)
  deleted_at       DateTime?  @db.DateTime(0)

  comments         Comment[]
  reviews          ComicReview[]
  views            ComicView[]
  profile          Profile?
  user_groups      UserGroup[]
  user_role_assignments UserRoleAssignment[]

  @@map("users")
  @@index([deleted_at], map: "idx_deleted_at")
}

model Profile {
  id               BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  user_id          BigInt    @unique @db.UnsignedBigInt
  name             String?   @db.VarChar(255)
  image            String?   @db.VarChar(255)
  birthday         DateTime? @db.Date
  gender           Gender?
  address          String?   @db.Text
  about            String?   @db.Text
  created_user_id  BigInt?   @db.UnsignedBigInt
  updated_user_id  BigInt?   @db.UnsignedBigInt
  created_at       DateTime  @default(now()) @db.DateTime(0)
  updated_at       DateTime  @updatedAt @db.DateTime(0)
  deleted_at       DateTime? @db.DateTime(0)

  user             User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("profiles")
  @@index([user_id], map: "UQ_profiles_user_id")
  @@index([deleted_at], map: "idx_profiles_deleted_at")
}

model Context {
  id               BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  type             String    @db.VarChar(50)
  ref_id           BigInt?   @db.UnsignedBigInt
  name             String    @db.VarChar(255)
  code             String    @unique @db.VarChar(100)
  status           String    @default("active") @db.VarChar(30)
  created_user_id  BigInt?   @db.UnsignedBigInt
  updated_user_id  BigInt?   @db.UnsignedBigInt
  created_at       DateTime  @default(now()) @db.DateTime(0)
  updated_at       DateTime  @updatedAt @db.DateTime(0)
  deleted_at       DateTime? @db.DateTime(0)

  groups           Group[]
  role_contexts    RoleContext[]

  @@map("contexts")
  @@unique([type, ref_id], map: "idx_contexts_type_ref_id")
  @@index([deleted_at], map: "idx_deleted_at")
}

model Group {
  id                   BigInt                @id @default(autoincrement()) @db.UnsignedBigInt
  type                 String                @db.VarChar(50)
  code                 String                @unique @db.VarChar(100)
  name                 String                @db.VarChar(255)
  description          String?               @db.Text
  status               String                @default("active") @db.VarChar(30)
  owner_id             BigInt?               @db.UnsignedBigInt
  context_id           BigInt                @db.UnsignedBigInt
  metadata             Json?
  created_user_id      BigInt?               @db.UnsignedBigInt
  updated_user_id      BigInt?               @db.UnsignedBigInt
  created_at           DateTime              @default(now()) @db.DateTime(0)
  updated_at           DateTime              @updatedAt @db.DateTime(0)
  deleted_at           DateTime?             @db.DateTime(0)

  context              Context               @relation(fields: [context_id], references: [id], onDelete: Restrict)
  user_groups          UserGroup[]
  user_role_assignments UserRoleAssignment[]

  @@map("groups")
  @@unique([type, code], map: "idx_groups_type_code")
  @@index([deleted_at], map: "idx_deleted_at")
  @@index([context_id], map: "IDX_groups_context_id")
}

model UserGroup {
  user_id    BigInt   @db.UnsignedBigInt
  group_id   BigInt   @db.UnsignedBigInt
  joined_at  DateTime @default(now()) @db.DateTime(0)

  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  group      Group    @relation(fields: [group_id], references: [id], onDelete: Cascade)

  @@id([user_id, group_id])
  @@map("user_groups")
  @@index([user_id], map: "idx_user_id")
  @@index([group_id], map: "idx_group_id")
}

model Permission {
  id               BigInt           @id @default(autoincrement()) @db.UnsignedBigInt
  code             String           @unique @db.VarChar(120)
  scope            String           @default("context") @db.VarChar(30)
  name             String?          @db.VarChar(150)
  status           String           @default("active") @db.VarChar(30)
  parent_id        BigInt?          @db.UnsignedBigInt
  created_user_id  BigInt?          @db.UnsignedBigInt
  updated_user_id  BigInt?          @db.UnsignedBigInt
  created_at       DateTime         @default(now()) @db.DateTime(0)
  updated_at       DateTime         @updatedAt @db.DateTime(0)
  deleted_at       DateTime?        @db.DateTime(0)

  parent           Permission?      @relation("PermissionHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  children         Permission[]     @relation("PermissionHierarchy")
  role_links       RoleHasPermission[]

  @@map("permissions")
  @@index([scope], map: "idx_scope")
  @@index([parent_id], map: "idx_parent_id")
  @@index([deleted_at], map: "idx_deleted_at")
}

model Role {
  id                    BigInt               @id @default(autoincrement()) @db.UnsignedBigInt
  code                  String               @db.VarChar(100)
  name                  String?              @db.VarChar(150)
  status                String               @default("active") @db.VarChar(30)
  parent_id             BigInt?              @db.UnsignedBigInt
  created_user_id       BigInt?              @db.UnsignedBigInt
  updated_user_id       BigInt?              @db.UnsignedBigInt
  created_at            DateTime             @default(now()) @db.DateTime(0)
  updated_at            DateTime             @updatedAt @db.DateTime(0)
  deleted_at            DateTime?            @db.DateTime(0)

  parent                Role?                @relation("RoleHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  children              Role[]               @relation("RoleHierarchy")
  permissions           RoleHasPermission[]
  role_contexts         RoleContext[]
  user_role_assignments UserRoleAssignment[]

  @@map("roles")
  @@unique([code], map: "roles_code_key")
  @@index([deleted_at], map: "idx_deleted_at")
}

model RoleHasPermission {
  role_id       BigInt      @db.UnsignedBigInt
  permission_id BigInt      @db.UnsignedBigInt

  role          Role        @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission    Permission  @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@id([role_id, permission_id])
  @@map("role_has_permissions")
  @@index([role_id], map: "idx_role_id")
  @@index([permission_id], map: "idx_permission_id")
}

model RoleContext {
  role_id    BigInt   @db.UnsignedBigInt
  context_id BigInt   @db.UnsignedBigInt

  role       Role     @relation(fields: [role_id], references: [id], onDelete: Cascade)
  context    Context  @relation(fields: [context_id], references: [id], onDelete: Cascade)

  @@id([role_id, context_id])
  @@map("role_contexts")
  @@index([role_id], map: "idx_role_id")
  @@index([context_id], map: "idx_context_id")
}

model UserRoleAssignment {
  id         BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  user_id    BigInt   @db.UnsignedBigInt
  role_id    BigInt   @db.UnsignedBigInt
  group_id   BigInt   @db.UnsignedBigInt
  created_at DateTime @default(now()) @db.DateTime(0)

  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [role_id], references: [id], onDelete: Cascade)
  group      Group    @relation(fields: [group_id], references: [id], onDelete: Cascade)

  @@map("user_role_assignments")
  @@index([user_id, group_id], map: "idx_user_group")
  @@index([group_id], map: "idx_group_id")
  @@index([role_id], map: "idx_role_id")
  @@unique([user_id, role_id, group_id], map: "idx_user_role_group_unique")
}

